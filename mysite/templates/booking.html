{% extends "layout.html" %}
{% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.cdnjs.com/ajax/libs/json2/20110223/json2.js"></script>
<script>
    $(document).ready(function(){
        get_room_availabilities();
        $("#check_in_date, #check_out_date").change(function(){
            get_room_availabilities();
        });
    });

    function get_room_availabilities(){
        alert("hello")
        var room_ids = [];
        room_ids = get_room_ids();
        var check_in_data = $('#check_in_date').val()
        var check_out_data = $('#check_out_date').val()
        // var guest_num =

        $.ajax({
            
            type: "GET",
            url: "/getdata/",
            dataType: "json",
            async: true,
            data: { csrfmiddlewaretoken: '{{ csrf_token }}', check_in_data : check_in_data,
                        check_out_data : check_out_data, room_ids : JSON.stringify(room_ids),},
            success: function(json) {
                
                // $('#output').html(json.message)
                update_rooms(json.message)
                // alert(json.message[1].length)
            }
        })
        // alert("inside")
    }

    function get_room_ids(){
        //var num_rooms = {{p.size}};
        var room_ids=[];
        $(":checkbox").each(function () {
            var id = $(this).attr("id");
            room_ids.push(id);
        });
        return room_ids
    }

    function update_rooms(room_attr){
        var i;
        alert(room_attr.length);
        for(i = 0; i < room_attr.length; i++) {
            room_id = room_attr[i].room_id;
            availability = room_attr[i].availability;
            if (availability == true) {
                $('#' + room_id + 'availability').text("Available")
            }
            else {
                booked_user = room_attr[i].booked_user;
                $('#' + room_id).attr('disabled', 'disabled')
                $('#' + room_id + 'availability').text("Not Available")
                $('#' + room_id + 'booked_user_profile').attr('href','/profile')
                // TODO
                $('#' + room_id + 'booked_user_profile').text('profile link')
            }
        }
    }
</script>

<style>
    .jumbotron {
        position: relative;
        color: white;
    }

        .jumbotron::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("https://images.unsplash.com/photo-1516156008625-3a9d6067fab5?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80");
            filter: blur(8px);
        }

    .display-3 {
        position: relative;
    }

    .btn-lg {
        position: relative;
    }
</style>
<!-- Jumbotron Header -->
<div class="container">
    <header class="jumbotron my-4">
        <h1 class="display-3">Book Property</h1>
        <p class="lead"></p>
    </header>

    <div class="booking_form">
        <form method="post">
            {% csrf_token %}
            {% if check_in_error %}<p><strong>{{ check_in_error }}</strong></p>{% endif %}
            {% if check_ou_error %}<p><strong>{{ check_out_error }}</strong></p>{% endif %}
            <div class="form-group lead">
                <label for="check_in_date">Check In Date:</label>
                <input type="date" class="form-control" id="check_in_date" name="check_in_date" value={{check_in}}> 
            </div>
            <div class="form-group lead">
                <label for="check_out_date">Check Out Date:</label>
                <input type="date" class="form-control" id="check_out_date" name="check_out_date"value={{check_out}}> 
            </div>

            <div class="form-group ead">
                <label for="rooms">Select Rooms:</label> 
                    <br>
                    {% for r in rooms %}
            
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id={{r.room_id}} name=rooms value={{r.room_id}}>
                        <label class="form-check-label" for={{r.room_id}}>
                            <Strong>Room {{forloop.counter}} </Strong> <br>
                            <div>Description: {{r.description}}</div>
                            <div>Size: {{r.num_guests}}</div>
                            <div id={{r.room_id}}availability></div>
                            <a id={{r.room_id}}booked_user_profile></a>
                        </label> <br>
                        
                        
                    </div>
                    {% endfor %}
                
            </div>

            <div class="form-group lead">
                <label for="num_guests">Number of Guests:</label>
                <input type="number" class="form-control" id="num_guest" name="num_guests" min="1"> 
            </div>

            <div id="output">

            </div>

            
            <input type="submit" value="Book" class="btn btn-primary btn-lg"><br><br />
        </form>
    </div>
</div>

{% endblock %}