{% extends "layout.html" %}
{% block content %}

<script>
    $(document).ready(function(){
        get_room_availabilities();
        var today = get_today_date();
        $("#check_in_date").attr('min',today)
        if( $("#check_in_date").val() != '' ) {
            var checkin = $("#check_in_date").val()
            $("#check_out_date").attr('min',checkin)
        } else {
            $("#check_out_date").attr('min',today)
        }
        $("#check_in_date, #check_out_date").change(function(){
            get_room_availabilities();
        });
    });

    function get_room_availabilities(){
        var room_ids = [];
        room_ids = get_room_ids();
        var check_in_data = $('#check_in_date').val()
        var check_out_data = $('#check_out_date').val()

        $.ajax({
            type: "GET",
            url: "/getdata/",
            dataType: "json",
            async: true,
            data: { csrfmiddlewaretoken: '{{ csrf_token }}', check_in_data : check_in_data,
                        check_out_data : check_out_data, room_ids : JSON.stringify(room_ids),},
            success: function(json) {
                update_rooms(json.message)
            }
        })
    }

    function get_room_ids(){
        //var num_rooms = {{p.size}};
        var room_ids=[];
        $(":checkbox").each(function () {
            var id = $(this).attr("id");
            room_ids.push(id);
        });
        return room_ids
    }

    function update_rooms(room_attr){
        var i;
        for(i = 0; i < room_attr.length; i++) {
            room_id = room_attr[i].room_id;
            availability = room_attr[i].availability;
            if (availability == true) {
                $('#' + room_id).removeAttr('disabled')
                $('#' + room_id + 'booked_user_profile').removeAttr('href')
                $('#' + room_id + 'booked_user_profile').text("")
                $('#' + room_id + 'availability').text("Available")
            }
            else {
                booked_user = room_attr[i].booked_user;
                $('#' + room_id).prop("checked", false);
                $('#' + room_id).attr('disabled', 'disabled')
                $('#' + room_id + 'availability').text("Not Available")
                $('#' + room_id + 'booked_user_profile').attr('href','/profile')
                // TODO
                $('#' + room_id + 'booked_user_profile').text('profile link')
            }
        }
    }
    
    function get_today_date(){
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth()+1; //January is 0!
        var yyyy = today.getFullYear();
        if(dd < 10){
            dd ='0'+ dd;
        } 
        if(mm < 10){
            mm = '0' + mm;
        } 
        today = yyyy + '-' + mm + '-' + dd;
        return today;
    }
</script>

<style>
    .jumbotron {
        position: relative;
        color: white;
    }
        .jumbotron::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("https://images.unsplash.com/photo-1516156008625-3a9d6067fab5?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1350&q=80");
            filter: blur(8px);
        }
    .display-3 {
        position: relative;
    }
    .btn-lg {
        position: relative;
    }
</style>

<!-- Jumbotron Header -->
<div class="container">
    <header class="jumbotron my-4">
        <h1 class="display-3">Book Property</h1>
        <p class="lead"></p>
    </header>
    <div class="booking_form">
        <form method="post">
            {% csrf_token %}
            {% if error %}<p><strong>{{ error }}</strong></p>{% endif %}
            <div class="form-group lead">
                <label for="check_in_date">Check In Date:</label>
                <input type="date" class="form-control" id="check_in_date" name="check_in_date" value={{check_in}}> 
            </div>
            <div class="form-group lead">
                <label for="check_out_date">Check Out Date:</label>
                <input type="date" class="form-control" id="check_out_date" name="check_out_date"value={{check_out}}> 
            </div>
            {% if p.shareable is true %}
            <div class="form-group lead">
                <label for="rooms">Select Rooms:</label> 
                    <br>
                    {% for r in rooms %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-label" type="checkbox" id={{r.room_id}} name=rooms value={{r.room_id}}>
                        <label class="form-check-label" for={{r.room_id}}>
                            <Strong>Room {{forloop.counter}} </Strong> <br>
                            <div>Description: {{r.description}}</div>
                            <div>Size: {{r.num_guests}}</div>
                            <div>Price: ${{r.price}} per night</div>
                            <div id={{r.room_id}}availability></div>
                            <a id={{r.room_id}}booked_user_profile></a>
                        </label> <br>
                    </div>
                    {% endfor %}
            </div>
            {% endif %}
            <div class="form-group lead">
                <label for="num_guests">Number of Guests:</label>
                <input type="number" class="form-control" id="num_guest" name="num_guests" min="1"> 
            </div>

            <!-- <div class="lead">
                <button class= "btn btn-secondary" type="button" id="check_price">Calculate Total Price</button>
                <div>
                </div>
                <br>
            </div> -->

            <input type="submit" value="Book" class="btn btn-primary btn-lg"><br><br>
        </form>
    </div>
</div>

{% endblock %}